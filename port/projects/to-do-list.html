<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do List App</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            /* Removed display: flex, justify-content, align-items, min-height for integration */
            margin: 0;
        }

        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            margin: 20px auto; /* Centered the container */
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .input-section {
            display: flex;
            flex-wrap: wrap; /* Allow items to wrap to the next line */
            gap: 10px; /* Space between input fields */
            margin-bottom: 20px;
        }

        #todo-input,
        #deadline-input,
        #reminder-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px; /* Apply border-radius to all corners */
            outline: none;
            min-width: 150px; /* Ensure inputs are not too small */
        }

        #add-button {
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px; /* Apply border-radius to all corners */
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex-shrink: 0; /* Prevent button from shrinking */
        }

        #add-button:hover {
            background-color: #218838;
        }

        .deadline-display,
        .reminder-display {
            font-size: 0.9em;
            color: #666;
            margin-left: 10px;
        }

        .deadline-display.overdue {
            color: #dc3545; /* Red color for overdue deadlines */
            font-weight: bold;
        }

        #todo-list {
            list-style: none;
            padding: 0;
        }

        #todo-list li {
            background-color: #f9f9f9;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eee;
        }

        #todo-list li.completed {
            text-decoration: line-through;
            color: #888;
            background-color: #e9e9e9;
        }

        #todo-list li button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #todo-list li button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <header>
        <h1>To Do List</h1>
        <nav>
            <ul>
                <li><a href="../index.html">Home</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section>
            <h2>To-Do List App</h2>
            <div class="container">
                <h1>To-Do List</h1>
                <div class="input-section">
                    <input type="text" id="todo-input" placeholder="Add a new to-do">
                    <input type="datetime-local" id="deadline-input">
                    <input type="text" id="reminder-input" placeholder="Add a reminder (e.g., 10 mins before, every 5 mins)">
                    <button id="add-button">Add</button>
                </div>
                <ul id="todo-list"></ul>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 My Portfolio</p>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const todoInput = document.getElementById('todo-input');
            const deadlineInput = document.getElementById('deadline-input');
            const reminderInput = document.getElementById('reminder-input');
            const addButton = document.getElementById('add-button');
            const todoList = document.getElementById('todo-list');

            let todos = JSON.parse(localStorage.getItem('todos')) || [];
            let reminderTimers = {}; // To store setInterval IDs for recurring reminders
            let deadlineTimers = {}; // To store setTimeout IDs for deadline alerts

            const saveTodos = () => {
                localStorage.setItem('todos', JSON.stringify(todos));
            };

            const clearAllTimers = (index) => {
                if (reminderTimers[index]) {
                    clearInterval(reminderTimers[index]);
                    delete reminderTimers[index];
                }
                if (deadlineTimers[index]) {
                    clearTimeout(deadlineTimers[index]);
                    delete deadlineTimers[index];
                }
            };

            const scheduleTimers = (todo, index) => {
                clearAllTimers(index); // Clear existing timers for this todo

                if (!todo.completed && todo.deadline) {
                    const deadlineTime = new Date(todo.deadline).getTime();
                    const now = new Date().getTime();

                    // 1. Schedule Deadline Alert
                    if (deadlineTime > now) {
                        deadlineTimers[index] = setTimeout(() => {
                            alert(`DEADLINE REACHED for "${todo.text}"! It was due at ${new Date(todo.deadline).toLocaleString()}`);
                            clearAllTimers(index); // Clear all timers once deadline is reached
                            renderTodos(); // Re-render to update overdue status
                        }, deadlineTime - now);
                    }

                    // 2. Schedule Reminder(s)
                    if (todo.reminder) {
                        let reminderOffsetMs = 0;
                        let isRecurring = false;
                        let recurrenceIntervalMs = 0;

                        const reminderMatch = todo.reminder.match(/(\d+)\s*(min|hour)s?\s*before/i);
                        const recurringMatch = todo.reminder.match(/every\s*(\d+)\s*(min|hour)s?/i);

                        if (reminderMatch) {
                            const value = parseInt(reminderMatch[1]);
                            const unit = reminderMatch[2].toLowerCase();
                            if (unit === 'min') {
                                reminderOffsetMs = value * 60 * 1000;
                            } else if (unit === 'hour') {
                                reminderOffsetMs = value * 60 * 60 * 1000;
                            }
                        }

                        if (recurringMatch) {
                            isRecurring = true;
                            const value = parseInt(recurringMatch[1]);
                            const unit = recurringMatch[2].toLowerCase();
                            if (unit === 'min') {
                                recurrenceIntervalMs = value * 60 * 1000;
                            } else if (unit === 'hour') {
                                recurrenceIntervalMs = value * 60 * 60 * 1000;
                            }
                        }

                        const firstReminderTime = deadlineTime - reminderOffsetMs;

                        const triggerReminderAlert = () => {
                            // Only trigger if not completed and before deadline
                            if (!todos[index].completed && new Date().getTime() < deadlineTime) {
                                alert(`REMINDER for "${todo.text}"! Deadline is ${new Date(todo.deadline).toLocaleString()}`);
                            } else {
                                // If completed or past deadline, clear this reminder
                                if (reminderTimers[index]) {
                                    clearInterval(reminderTimers[index]);
                                    delete reminderTimers[index];
                                }
                            }
                        };

                        if (isRecurring && recurrenceIntervalMs > 0) {
                            // Schedule the first reminder
                            if (firstReminderTime > now) {
                                reminderTimers[index] = setTimeout(() => {
                                    triggerReminderAlert(); // Trigger the first reminder
                                    // Then set up recurring reminders until deadline
                                    if (new Date().getTime() < deadlineTime) {
                                        reminderTimers[index] = setInterval(triggerReminderAlert, recurrenceIntervalMs);
                                    }
                                }, firstReminderTime - now);
                            } else if (deadlineTime > now) {
                                // If first reminder time is in the past but deadline is in the future, start recurring immediately
                                triggerReminderAlert(); // Trigger immediately
                                reminderTimers[index] = setInterval(triggerReminderAlert, recurrenceIntervalMs);
                            }
                        } else if (firstReminderTime > now) {
                            // For single reminders, schedule a setTimeout
                            reminderTimers[index] = setTimeout(triggerReminderAlert, firstReminderTime - now);
                        }
                    }
                }
            };

            const renderTodos = () => {
                todoList.innerHTML = '';
                todos.forEach((todo, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = todo.completed ? 'completed' : '';

                    let deadlineDisplay = '';
                    if (todo.deadline) {
                        const deadlineDate = new Date(todo.deadline);
                        const now = new Date();
                        const isOverdue = !todo.completed && deadlineDate < now;
                        deadlineDisplay = `<span class="deadline-display ${isOverdue ? 'overdue' : ''}">Deadline: ${deadlineDate.toLocaleString()}</span>`;
                    }

                    let reminderDisplay = '';
                    if (todo.reminder) {
                        reminderDisplay = `<span class="reminder-display">Reminder: ${todo.reminder}</span>`;
                    }

                    listItem.innerHTML = `
                        <span>${todo.text}</span>
                        <div class="todo-meta">
                            ${deadlineDisplay}
                            ${reminderDisplay}
                        </div>
                        <div>
                            <button data-index="${index}" class="complete-button">${todo.completed ? 'Uncomplete' : 'Complete'}</button>
                            <button data-index="${index}" class="delete-button">Delete</button>
                        </div>
                    `;
                    todoList.appendChild(listItem);
                    scheduleTimers(todo, index); // Schedule both deadline and reminder timers
                });
            };

            const addTodo = () => {
                const todoText = todoInput.value.trim();
                const deadline = deadlineInput.value; // datetime-local value
                const reminder = reminderInput.value.trim();

                if (todoText !== '') {
                    const newTodo = {
                        text: todoText,
                        completed: false,
                        deadline: deadline || null,
                        reminder: reminder || null
                    };
                    todos.push(newTodo);
                    todoInput.value = '';
                    deadlineInput.value = '';
                    reminderInput.value = '';
                    saveTodos();
                    renderTodos();
                }
            };

            const toggleComplete = (index) => {
                todos[index].completed = !todos[index].completed;
                if (todos[index].completed) {
                    clearAllTimers(index); // Clear all timers if todo is completed
                }
                saveTodos();
                renderTodos();
            };

            const deleteTodo = (index) => {
                clearAllTimers(index); // Clear all timers before deleting
                todos.splice(index, 1);
                saveTodos();
                renderTodos();
            };

            addButton.addEventListener('click', addTodo);

            todoInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addTodo();
                }
            });

            todoList.addEventListener('click', (e) => {
                if (e.target.classList.contains('complete-button')) {
                    const index = e.target.dataset.index;
                    toggleComplete(index);
                } else if (e.target.classList.contains('delete-button')) {
                    const index = e.target.dataset.index;
                    deleteTodo(index);
                }
            });

            // Initial render and schedule all timers
            renderTodos();
            // Re-render periodically to update overdue status
            setInterval(renderTodos, 10 * 1000); // Check every 10 seconds
        });
    </script>
</body>
</html>